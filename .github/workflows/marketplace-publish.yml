name: Publish Extension
on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

env:
    NODE_VERSION: 20.20.0
    PNPM_VERSION: 10.8.1

jobs:
    publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  ref: ${{ github.sha }}
            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}
            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"
            - name: Install dependencies
              run: pnpm install
            - name: Get version
              id: get-version
              run: |
                  if [[ $GITHUB_REF == refs/tags/v* ]]; then
                    # Extract version from tag (e.g., refs/tags/v1.2.3 -> 1.2.3)
                    current_package_version=${GITHUB_REF#refs/tags/v}
                  else
                    # Fallback to package.json for manual triggers
                    current_package_version=$(node -p "require('./src/package.json').version")
                  fi
                  echo "version=${current_package_version}" >> $GITHUB_OUTPUT
                  echo "Version: ${current_package_version}"
            - name: Update package.json version
              run: |
                  current_package_version=${{ steps.get-version.outputs.version }}
                  cd src
                  npm version $current_package_version --no-git-tag-version
            - name: Package Extension
              run: |
                  current_package_version=${{ steps.get-version.outputs.version }}
                  pnpm vsix:production

                  # Save VSIX contents to a temporary file to avoid broken pipe issues.
                  unzip -l bin/copy-coder-${current_package_version}.vsix > /tmp/copy-coder-vsix-contents.txt

                  # Check for required files.
                  grep -q "extension/package.json" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q "extension/package.nls.json" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q "extension/dist/extension.js" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q "extension/webview-ui/audio/celebration.wav" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q "extension/webview-ui/build/assets/index.js" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q "extension/assets/codicons/codicon.ttf" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q "extension/assets/vscode-material-icons/icons/3d.svg" /tmp/copy-coder-vsix-contents.txt || exit 1
                  grep -q ".env" /tmp/copy-coder-vsix-contents.txt || exit 1

                  # Clean up temporary file.
                  rm /tmp/copy-coder-vsix-contents.txt
            - name: Publish to VS Code Marketplace
              env:
                  VSCE_PAT: ${{ secrets.VSCODE_MARKETPLACE_TOKEN }}
              run: |
                  current_package_version=${{ steps.get-version.outputs.version }}
                  cd src
                  npx vsce publish --packagePath ../bin/copy-coder-${current_package_version}.vsix
                  echo "Successfully published version $current_package_version to VS Code Marketplace"

